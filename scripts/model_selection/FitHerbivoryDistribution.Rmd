---
title: "Fit Herbivory Average Distribution"
author: "M. Drew LaMar"
date: "May 23, 2016"
output: 
  html_document:
    toc: true
---

We use the `fdistrplus` package (https://cran.r-project.org/web/packages/fitdistrplus/vignettes/paper2JSS.pdf)

```{r, warning=FALSE, message=FALSE}
source("../../.Rprofile")
```

Read and filter.
```{r}
metadata <- tbl_df(read.csv(mwROOT("data","stemdata.csv")))

metadata %<>% filter(!is.na(h_apical),
                     !is.na(munched))
```

# Bertha

First grab probability of being munched.
```{r}
(pmunch <- sum(metadata$munched == 1)/nrow(metadata))
```

Now do fits for herbivory scores of munched plants.
```{r}
herb_avg <- (metadata %>% filter(munched == 1))$herb_avg

f0 <- fitdist(herb_avg, "norm")
f1 <- fitdist(herb_avg, "lnorm")
f2 <- fitdist(herb_avg, "gamma")
f3 <- fitdist(herb_avg, "exp")
f4 <- fitdist(herb_avg, "weibull")
```

Plot results.
```{r}
par(mfrow=c(2,2))
plot.legend <- c("norm", "lnorm", "gamma", "exp", "weibull")
denscomp(list(f0, f1, f2, f3, f4), legendtext = plot.legend)
cdfcomp(list(f0, f1, f2, f3, f4), legendtext = plot.legend)
qqcomp(list(f0, f1, f2, f3, f4), legendtext = plot.legend)
ppcomp(list(f0, f1, f2, f3, f4), legendtext = plot.legend)
```

Goodness-of-fit measures.
```{r}
gofstat(list(f0, f1, f2, f3, f4), fitnames = plot.legend)
```

Estimates.  The inputs to predict always on [0, xmax], broken up into equal intervals.
```{r}
sites <- c("Bertha", "BLD1", "BLD2", "PWR", "SKY", "YTB")
munched.fit <- vector('list', 6)
names(munched.fit) <- sites

munched.fit[['Bertha']] <- vector("list", 3)
munched.fit[['Bertha']][[1]] <- f1
munched.fit[['Bertha']][[2]] <- pmunch

# Two ways to take care of missing probability.  Choosing to spread as opposed to adding to endpoints.  Other technique commented out here.
#  y[2] <- y[2] + p%s(z[2], %g, %g)
#  y[N] <- y[N] + p%s(z[N], %g, %g, lower.tail=FALSE)
munched.fit[['Bertha']][[3]] <- eval(parse(text = sprintf("function(x, justmunch=FALSE) {
  N <- length(x)
  dx <- x[2]-x[1]
  z <- exp(x)-0.1
  y <- rep(0, N)
  for (j in 1:(N-1)) {
    y[j] = p%s(z[j+1], %g, %g) - p%s(z[j], %g, %g)
  }
  y <- (%g/(dx*sum(y)))*y
  if (!justmunch) {
    y[1] <- y[1] + (1-%g)/dx
  }
  y <- y[1:(N-1)]
}", munched.fit[[1]][[1]]$distname, munched.fit[[1]][[1]]$estimate[1], munched.fit[[1]][[1]]$estimate[2],
  munched.fit[[1]][[1]]$distname, munched.fit[[1]][[1]]$estimate[1], munched.fit[[1]][[1]]$estimate[2],
  munched.fit[[1]][[2]], munched.fit[[1]][[2]]
)))
names(munched.fit[['Bertha']]) <- c("fit", "pmunch", "predict")
```

To illustrate how this would be used, we need a point mass at the origin with the rest the log-normal.
```{r}
par(mfrow=c(1,1))
bx <- seq(from = log(0.1), to = log(6.1), length.out=101)
x <- 0.5*(bx[1:100] + bx[2:101])
# Calculate log transformed herbivory averages and visually check fit
herb_avg <- log(0.1+metadata$herb_avg)
hist(herb_avg, breaks=seq(from = log(0.1), to = log(6.1), by=0.05), freq=FALSE)
lines(x, munched.fit[['Bertha']]$predict(bx), col="red", lwd=2)
```

# Sites

```{r}
for (i in 2:6) {
  thissite <- metadata %>% filter(site == sites[i])
  pmunch <- sum(thissite$munched == 1)/nrow(thissite)
  herb_avg <- (thissite %>% filter(munched == 1))$herb_avg
  
  f0 <- fitdist(herb_avg, "norm")
  f1 <- fitdist(herb_avg, "lnorm")
  f2 <- fitdist(herb_avg, "gamma")
  f3 <- fitdist(herb_avg, "exp")
  f4 <- fitdist(herb_avg, "weibull")
  
  ind <- which.min(gofstat(list(f0, f1, f2, f3, f4))$aic)
  
  munched.fit[[i]] <- vector("list", 3)
  eval(parse(text=sprintf("munched.fit[[%d]][[1]] <- f%d", i, ind-1)))
  munched.fit[[i]][[2]] <- pmunch
  munched.fit[[i]][[3]] <- eval(parse(text = sprintf("function(x, justmunch=FALSE) {
    N <- length(x)
    dx <- x[2]-x[1]
    z <- exp(x)-0.1
    y <- rep(0, N)
    for (j in 1:(N-1)) {
      y[j] = p%s(z[j+1], %g, %g) - p%s(z[j], %g, %g)
    }
    y <- (%g/(dx*sum(y)))*y
    if (!justmunch) {
      y[1] <- y[1] + (1-%g)/dx
    }
    y <- y[1:(N-1)]
  }", munched.fit[[i]][[1]]$distname, munched.fit[[i]][[1]]$estimate[1], munched.fit[[i]][[1]]$estimate[2],
  munched.fit[[i]][[1]]$distname, munched.fit[[i]][[1]]$estimate[1], munched.fit[[i]][[1]]$estimate[2],
  munched.fit[[i]][[2]], munched.fit[[i]][[2]])))

  names(munched.fit[[i]]) <- c("fit", "pmunch", "predict")
  cat("\n-------\n")
  cat(sites[i], "\n")
  print(munched.fit[[sites[i]]])
}
```

```{r, warning=FALSE}
herb_predict <- function(x, fit, group) {
  fit[[group]]$predict(c(x, x[length(x)]+x[2]-x[1]))
}

x <- seq(from = log(0.1), to = log(6.1), length.out = 101)
curves <- do.call(rbind, lapply(sites[-1],
                                function(site) {
                                  data.frame(site = site,
                                             x = x,
                                             y = herb_predict(x, munched.fit, site))
                                }
))

p <- metadata %>% ggplot(aes(x = log(0.1+herb_avg))) +
  geom_histogram(aes(y = ..density..),
                 binwidth = 0.1) +
  geom_line(aes(x = x, 
                y = y), 
            data = curves, 
            colour = "red") +
  facet_wrap(~ site) +
  coord_cartesian(ylim=c(0, 2)) +
  theme_bw() +
  xlab("Ln(Herbivory Score)") +
  ylab("Density")

p
```