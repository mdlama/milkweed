---
title: "Figure 5"
output: 
  html_document:
    toc: true
---

# Initialization

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyr)
library(lme4)
library(plot3D) # For mesh function
library(ggplot2)
library(grid)
library(RColorBrewer)
library(scales)
library(gtable)
library(gridExtra)
```

```{r}
source("~/Google Drive/Project :: ipmwam/Papers/SivansPaper/DataAnalysis/mwMod.R")
source("~/Google Drive/Project :: ipmwam/Papers/SivansPaper/DataAnalysis/mwIPM.R")
```

Load and filter data.
```{r}
metadata=tbl_df(read.csv("~/Google Drive/Project :: ipmwam/Papers/SivansPaper/Milkweed/DATA SETS/Data Frames/metadata13to15.csv"))

# Where there was a plant in June and NA for height in Sept, make surv 0
metadata <- metadata %>% mutate(surv = ifelse(is.na(surv) & is.na(h_apical.next) & !is.na(h_apical), 0, surv), 
                                munched = ifelse(herb_avg > 0, 1, 0),
                                log_herb_avg = log(0.1+herb_avg),
                                h_apical.next > 50,
                                !(site == "YTB" & h_apical <= 50)) %>%
  filter(site == site)
```

```{r}
compute <- TRUE
sites <- c("Bertha", "BLD1", "BLD2", "PWR", "SKY", "YTB")

if (compute) {
  plotdata <- data.frame()
  for (i in 1:length(sites)) {
    ipm <- mwIPM(list(data = metadata, N = 50, site = sites[i]))
    plotdata <- rbind(plotdata, data.frame(log_herb_avg = ipm$vars$log_herb_avg$x,
                                           growth_rate = sapply(1:ipm$N, function (x) { ipm %>% setHerbivory(dist.herb = c(rep(0,x-1), 1/ipm$vars$log_herb_avg$dx, rep(0,ipm$N-x))) %>% analyzeGrowthRate() }), site = sites[i]))
  }
  save(plotdata, file="~/Google Drive/Project :: ipmwam/Papers/SivansPaper/Figures/Figure 5/plotdata.RData")
} else {
  load("~/Google Drive/Project :: ipmwam/Papers/SivansPaper/Figures/Figure 5/plotdata.RData")
}
plotdata <- rbind(plotdata, data.frame(log_herb_avg = ipm$vars$log_herb_avg$x,
                                       growth_rate = exp(predict(ipm$pars$budlings.per.stem.fit, new = data.frame(log_herb_mean = ipm$vars$log_herb_avg$x))),
                                       site = "Sprouts/stem"))

plotdata$site <- factor(plotdata$site, levels = c("BLD1", "BLD2", "PWR", "SKY", "YTB", "Bertha", "Sprouts/stem"))

p <- plotdata %>% ggplot(aes(x = log_herb_avg,
             y = growth_rate,
             color = site,
             linetype = site)) +
  geom_line(size = 0.5) + 
  scale_color_manual(values = c(hue_pal()(5), "black", "black")) + 
  scale_linetype_manual(values = c(1,1,1,1,1,1,2)) +
  scale_y_continuous(limits = c(0, 2.0)) +
  labs(colour="Sites", linetype="Sites")

# p <- p + geom_line(data=plotdata %>% filter(site == "Bertha"), color="black")

p

# PWR, YTB, and BLD2 are right on top of one another
```

```{r, eval=F}
ipm <- mwIPM(list(data = metadata,
                  N = 50,
                  site = "Bertha"))

plotdata <- data.frame(log_herb_avg = ipm$vars$log_herb_avg$x,
                       growth_rate = sapply(1:ipm$N, function (x) { analyzeGrowthRate(setHerbivory(ipm, dist.herb = c(rep(0,x-1), 1/ipm$vars$log_herb_avg$dx, rep(0,ipm$N-x)))) }),
                       buds_per_stem = exp(predict(ipm$pars$budlings.per.stem.fit, new = data.frame(log_herb_mean = ipm$vars$log_herb_avg$x))))

p <- plotdata %>% gather("type", "growth", 2:3) %>% 
  ggplot(aes(x = log_herb_avg,
             y = growth,
             linetype = type)) +
  geom_line() + 
  scale_linetype_manual(values=c("dashed", "solid"),
                        labels=c("Sprouts per stem", "Growth rate"))

p <- p + theme_bw() +
  xlab("ln(Herbivory Score)") +
  ylab("Population growth rate") +
  labs(linetype="") +
  theme(legend.background = element_rect(fill="lightgrey",
                                         size=0.1,
                                         linetype="solid"),
        legend.key.size =  unit(0.2, "in"),
        legend.position = c(0.875, 0.65))

p
```

Save figure.

```{r}
ggsave("../Figure5.png", height=4, width=6, device = "png", p)
```