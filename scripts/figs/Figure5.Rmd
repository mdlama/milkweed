---
title: "Figure 5"
output: 
  html_document:
    toc: true
---

# Initialization

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../../.Rprofile")
library(doParallel)
```

```{r}
compute <- FALSE

if (compute) {
  sites <- c("Bertha", "BLD1", "BLD2", "PWR", "SKY", "YTB")
  ipm <- mwIPM()
  plotdata <- data.frame(log_herb_avg = ipm$vars$log_herb_avg$x,
                         growth_rate = sapply(1:ipm$N, 
                                              function (x) { 
                                                ipm %>% 
                                                  setHerbivoryMatrix(dist.herb = c(rep(0,x-1), 1/ipm$vars$log_herb_avg$dx, rep(0,ipm$N-x))) %>% 
                                                  analyzeGrowthRate()
                                              }))
  
  cl <- makeCluster(6)
  registerDoParallel(cl)
  results <- tbl_df(foreach(i=1:10, .combine=bind_rows) %dopar% {
    source("../../.Rprofile")
    ipm %<>% bootIPM()
    thisone <- ipm$data %>% group_by(site) %>% summarize(log_herb_avg = mean(log_herb_avg, na.rm=T), growth_rate = NA)
    thisone$growth_rate <- sapply(sites[-1], function (x) {ipm %>% setSite(x) %>% analyzeGrowthRate()})
    thisone
  })
  
  save(plotdata, results, file=mwROOT("data","calculated","figure5.RData"))
} else {
  load(mwROOT("data","calculated","figure5.RData"))
}

p <- plotdata %>% ggplot(aes(x = log_herb_avg,
                             y = growth_rate)) +
                  geom_line()

p <- p + geom_point(aes(x = log_herb_avg, y = growth_rate, color = site), data=results) + stat_ellipse(aes(x = log_herb_avg, y = growth_rate, color = site), data = results)
```

```{r, eval=F}
compute <- TRUE
sites <- c("Bertha", "BLD1", "BLD2", "PWR", "SKY", "YTB")

ipm <- mwIPM()
plotdata <- data.frame()

if (compute) {
  plotdata <- data.frame()
  
  ipm <- ipm %>% setSite(sites[i])
    plotdata <- rbind(plotdata, data.frame(log_herb_avg = ipm$vars$log_herb_avg$x,
                                           growth_rate = sapply(1:ipm$N, function (x) { ipm %>% setHerbivoryMatrix(dist.herb = c(rep(0,x-1), 1/ipm$vars$log_herb_avg$dx, rep(0,ipm$N-x))) %>% analyzeGrowthRate() }), site = sites[i]))
    
  save(plotdata, file=mwROOT("data","calculated","figure5.RData"))
} else {
  load(mwROOT("data","calculated","figure5.RData"))
}
plotdata <- rbind(plotdata, data.frame(log_herb_avg = ipm$vars$log_herb_avg$x,
                                       growth_rate = exp(predict(ipm$pars$budlings.per.stem.fit, new = data.frame(log_herb_mean = ipm$vars$log_herb_avg$x))),
                                       site = "Sprouts/stem"))

plotdata$site <- factor(plotdata$site, levels = c("BLD1", "BLD2", "PWR", "SKY", "YTB", "Bertha", "Sprouts/stem"))

p <- plotdata %>% ggplot(aes(x = log_herb_avg,
             y = growth_rate,
             color = site,
             linetype = site)) +
  geom_line(size = 0.5) + 
  scale_color_manual(values = c(hue_pal()(5), "black", "black")) + 
  scale_linetype_manual(values = c(1,1,1,1,1,1,2)) +
  scale_y_continuous(limits = c(0, 2.0)) +
  labs(colour="Sites", linetype="Sites")

# p <- p + geom_line(data=plotdata %>% filter(site == "Bertha"), color="black")

p

# PWR, YTB, and BLD2 are right on top of one another
```

```{r, eval=F}
ipm <- mwIPM(list(data = metadata,
                  N = 50,
                  site = "Bertha"))

plotdata <- data.frame(log_herb_avg = ipm$vars$log_herb_avg$x,
                       growth_rate = sapply(1:ipm$N, function (x) { analyzeGrowthRate(setHerbivory(ipm, dist.herb = c(rep(0,x-1), 1/ipm$vars$log_herb_avg$dx, rep(0,ipm$N-x)))) }),
                       buds_per_stem = exp(predict(ipm$pars$budlings.per.stem.fit, new = data.frame(log_herb_mean = ipm$vars$log_herb_avg$x))))

p <- plotdata %>% gather("type", "growth", 2:3) %>% 
  ggplot(aes(x = log_herb_avg,
             y = growth,
             linetype = type)) +
  geom_line() + 
  scale_linetype_manual(values=c("dashed", "solid"),
                        labels=c("Sprouts per stem", "Growth rate"))

p <- p + theme_bw() +
  xlab("ln(Herbivory Score)") +
  ylab("Population growth rate") +
  labs(linetype="") +
  theme(legend.background = element_rect(fill="lightgrey",
                                         size=0.1,
                                         linetype="solid"),
        legend.key.size =  unit(0.2, "in"),
        legend.position = c(0.875, 0.65))

p
```

Save figure.

```{r}
# ggsave("../Figure5.png", height=4, width=6, device = "png", p)
```