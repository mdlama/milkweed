---
title: "Figure 6: Elasticity Analysis"
output: 
  html_document:
    toc: true
---

# Initialization

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../../.Rprofile")
library(tidyr)
library(doParallel)
```

```{r}
compute <- FALSE

if (compute) {
  ipm <- mwIPM()
  numcl <- detectCores()-1
  registerDoParallel(cores = numcl)
  results <- tbl_df(foreach(i=1:20, .combine=bind_rows) %dopar% {
    source("../../.Rprofile")
    ipm %<>% bootIPM() %>% analyzeParameters(compute = TRUE)
    thisone <- ipm$analysis$parameters %>% select(type, name, elasticity)
    thisone
  })
  
  save(results, file=mwROOT("data","calculated","figure6.RData"))
} else {
  load(mwROOT("data","calculated","figure6.RData"))
}
#unite(label, type, name, sep="-", remove=FALSE)
```

```{r}
plotdata <- results %>% 
  unite(label, type, name, sep="-", remove=FALSE) %>% 
  group_by(label) %>% 
  summarize(meanElasticity = mean(elasticity),
            n = n(),
            se = sd(elasticity)/sqrt(n),
            ci = qt(0.975, n-1)*se,
            type = last(type),
            name = last(name))

new.levels <- c("Clonal", "Clonal", "Sexual", "Growth", "Herbivory", "Sexual", "Sexual", "Sexual", "Survival")
plotdata$newtype <- factor(new.levels[plotdata$type])

xlabs <- plotdata %>% arrange(type) %>% select(name)
```

```{r}
myplot <- plotdata %>% 
  unite(label, type, name, sep="-", remove=FALSE) %>%
  ggplot(aes(x = label,
             y = meanElasticity,
             color = newtype, 
             fill = newtype)) +
  geom_hline(yintercept = 0, 
             linetype = 1,
             size = 0.2) +
  geom_point() + 
  geom_errorbar(aes(ymin = meanElasticity - ci,
                    ymax = meanElasticity + ci),
                width = 0.3) + 
  scale_x_discrete(labels=xlabs$name) +
  coord_flip() +
  theme_bw()

# geom_bar(stat = "identity") + 
```

# Archive

```{r, eval = F}
psens <- results %>% 
  filter(name != "seedling.emergence") %>% 
  unite(label, type, name, sep="-", remove=FALSE) %>% 
  ggplot(aes(x = label, 
             y = sensitivity, 
             color=newtype, 
             fill=newtype)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x=element_text(angle = -45, 
                                 hjust = 0)) + 
  scale_x_discrete(labels=xlabs$name)

results$lambda <- ipm %>% analyzeGrowthRate()
results %<>% mutate(elasticity = sensitivity/(lambda/pars))

pelast <- results %>% 
  unite(label, type, name, sep="-", remove=FALSE) %>% 
  ggplot(aes(x = label, 
             y = elasticity, 
             color=newtype, 
             fill=newtype)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x=element_text(angle = -45, 
                                 hjust = 0)) + 
  scale_x_discrete(labels=xlabs$name)

# ggsave(mwROOT("scripts","figs","Figure6.png"), height=4, width=6, device = "png", p)
```

```{r, eval=F}
results_long <- results %>% gather(measure, value, sensitivity, elasticity)

results_long$measure <- factor(results_long$measure, 
                               levels = c("sensitivity", 
                                          "elasticity"))

myplot <- results_long %>% 
  unite(label, type, name, sep="-", remove=FALSE) %>%
  group_by(measure) %>%
  ggplot(aes(x = label,
             y = value,
             color = newtype, 
             fill = newtype)) +
  geom_bar(stat = "identity") + 
  scale_x_discrete(labels=xlabs$name) +
  facet_grid(~ measure) +
  coord_flip(ylim=c(-2,2))
```