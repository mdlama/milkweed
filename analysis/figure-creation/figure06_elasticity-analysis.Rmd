---
title: "Figure 6: Elasticity analysis"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
---

# Initialization

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(milkweed)
library(dplyr)
library(ggplot2)
requirePackages(c("doParallel", "latex2exp"))
library(doParallel) # Normally, I don't load suggested packages, but this one requires and loads parallel, foreach, and iterators,
                    #   so, you know, it's easier this way.
'%<>%' <- magrittr::'%<>%'
TeX <- latex2exp::TeX
ipm = mwIPM(list(compute = TRUE, saveresults = FALSE))
#mwCache <- '../../data/mwCache'
```

# Analysis

## Bootstrap elasticities
```{r}
compute <- FALSE

ipm = mwIPM(list(compute = TRUE, saveresults = FALSE))

if (!file.exists(file.path(mwCache,"figure6.RData")) | (compute)) {
  numcl <- detectCores()-1
  registerDoParallel(cores = numcl)
  results <- tbl_df(foreach(i=1:4, .combine=bind_rows) %dopar% { #3 was previously 20
    library(milkweed)
    library(dplyr)
    '%<>%' <- magrittr::'%<>%'
    ipm %<>% bootIPM() %>% analyzeParameters(distpars = FALSE) #changed from TRUE
    thisone <- ipm$analysis$parameters #%>% select(type, name, elasticity)
    thisone
  })
  
  save(results, file=file.path(mwCache,"figure6.RData"))
} else {
  load(file.path(mwCache,"figure6.RData"))
}
```

## Spread elasticity over kernel for herbivory parameters
```{r}
ipm %<>% analyzeStandard() %>% analyzeParameters(distpars = TRUE)
res <- ipm$analysis$parameters %>% 
    filter(type == "Herbivory") %>% 
    select(pars, elasticity)

herbivory_func <- function(x) {
  as.vector((ipm %>% setHerbivoryMatrix(perturb = x, distpars = TRUE))$kernels$K)
}

J <- numDeriv::jacobian(herbivory_func, rep(0,3))

# Loops!?  We don't need no stinkin loops...
S1 <- ipm$analysis$standard$sens*matrix(J[,1], nrow=ipm$N)*ipm$vars$h_apical$dx # pmunch
S2 <- ipm$analysis$standard$sens*matrix(J[,2], nrow=ipm$N)*ipm$vars$h_apical$dx # mean
S3 <- ipm$analysis$standard$sens*matrix(J[,3], nrow=ipm$N)*ipm$vars$h_apical$dx # sd

E1 <- ipm$analysis$standard$elas*(matrix(J[,1], nrow=ipm$N)/(ipm$kernels$K/res$pars[1]))*ipm$vars$h_apical$dx
E2 <- ipm$analysis$standard$elas*(matrix(J[,2], nrow=ipm$N)/(ipm$kernels$K/res$pars[2]))*ipm$vars$h_apical$dx
E3 <- ipm$analysis$standard$elas*(matrix(J[,3], nrow=ipm$N)/(ipm$kernels$K/res$pars[3]))*ipm$vars$h_apical$dx

# Sanity check - sum of Ei should equal calculated elasticities
abs(sum(sum(E1)) - res$elasticity[1])
abs(sum(sum(E2)) - res$elasticity[2])
abs(sum(sum(E3)) - res$elasticity[3])
```

# Plotting

## Caterpillar plot of elasticities

### Prep the plot data

```{r}
plotdata <- ipm$analysis$parameters 
plotdata$name[which(plotdata$name == 'a')] = '(Intercept)'
plotdata$name[which(plotdata$name == 'b')] = 'Cardenolides'
plotdata %<>% tidyr::unite(label, type, name, sep="-", remove=FALSE) %>% 
              group_by(label) %>% 
              summarize(meanElasticity = mean(elasticity),
                        n = n(),
                        se = sd(elasticity)/sqrt(n),
                        ci = qt(0.975, n-1)*se,
                        type = last(type),
                        name = last(name))

# Group parameters for plotting
plotdata %<>% mutate(newtype = factor(ifelse(type %in% c('Flowering', 'Survival', 'Pods', 'Seedlings'), 'Sexual', ifelse(type %in% c('Clonal', 'Budlings'), 'Clonal', ifelse(type == 'Cardenolides', 'Cardenolides', ifelse(type == 'Herbivory', 'Herbivory', 'LMA'))))))

# Specify order of parameters in plot
newlabelorder <- c("Clonal-(Intercept)", 
                   "Clonal-Cardenolides", 
                   "Budlings-mean", 
                   "Budlings-sd", 
                   "Flowering-(Intercept)", 
                   "Flowering-h_apical", 
                   "Flowering-herb_avg", 
                   "Flowering-Cardenolides", 
                   "Survival-(Intercept)",
                   "Survival-h_apical",
                   "Survival-herb_avg",
                   "Survival-Cardenolides",
                   "Survival-LMA",
                   "Pods-(Intercept)", 
                   "Pods-h_apical", 
                   "Pods-herb_avg",
                   "Pods-Cardenolides",
                   "Pods-LMA",
                   "Seedlings-mean", 
                   "Seedlings-sd", 
                   "Seedlings-seedling.emergence", 
                   "Seedlings-seeds.per.pod",
                   "Herbivory-pmunch", 
                   "Herbivory-mean", 
                   "Herbivory-sd",
                   "Cardenolides-mean", 
                   "Cardenolides-sd", 
                   "LMA-mean", 
                   "LMA-sd")

# Corresponding mathematical symbols to above parameters
# These really ought to be done through plotmath notation:
#   https://stat.ethz.ch/R-manual/R-devel/library/grDevices/html/plotmath.html
fancypantslabels <- rev(newlabelorder)
fancypantslabels[1] <- TeX('$\\alpha$')
fancypantslabels[2] <- TeX('$\\beta_{z_{c}}$')

fancypantslabels[3] <- TeX('$\\mu$')
fancypantslabels[4] <- TeX('$\\sigma$')
fancypantslabels[5] <- TeX('$\\alpha$')
fancypantslabels[6] <- TeX('$\\beta_{z_{h}}$')
fancypantslabels[7] <- TeX('$\\beta_{z_{\\omega}}$')
fancypantslabels[8] <- TeX('$\\beta_{z_{c}}$')
fancypantslabels[9] <- TeX('$\\alpha$')
fancypantslabels[10] <- TeX('$\\beta_{z_{h}}$')
fancypantslabels[11] <- TeX('$\\beta_{z_{\\omega}}$')
fancypantslabels[12] <- TeX('$\\beta_{z_{c}}$')
fancypantslabels[13] <- TeX('$\\beta_{z_{\\l}}$')
fancypantslabels[14] <- TeX('$\\alpha$')
fancypantslabels[15] <- TeX('$\\beta_{z_{h}}$')
fancypantslabels[16] <- TeX('$\\beta_{z_{\\omega}}$')
fancypantslabels[17] <- TeX('$\\beta_{z_{c}}$')
fancypantslabels[18] <- TeX('$\\beta_{z_{l}}$')
fancypantslabels[19] <- TeX('$\\mu$')
fancypantslabels[20] <- TeX('$\\sigma$')
fancypantslabels[21] <- TeX('$\\alpha$')
fancypantslabels[22] <- TeX('$\\alpha$')

fancypantslabels[23] <- TeX('$p_{\\omega}$')
fancypantslabels[24] <- TeX('$\\mu$')
fancypantslabels[25] <- TeX('$\\sigma$')

fancypantslabels[26] <- TeX('$\\mu$')
fancypantslabels[27] <- TeX('$\\sigma$')

fancypantslabels[28] <- TeX('$\\mu$')
fancypantslabels[29] <- TeX('$\\sigma$')


# Legend ordering
newtypeorder <- c("Clonal", "Sexual", "Herbivory", "Cardenolides", "LMA")

# Colors
group.colors <- c("#F8766D", "#00BF7D", "#A3A500", "#E76BF3", "#00B0F6")
```

### Render elasticity caterpillar plot
```{r}
elastiplot <- plotdata %>% 
  mutate(label = factor(label, levels = rev(newlabelorder))) %>%
  mutate(newtype = factor(newtype, levels = newtypeorder)) %>%
  ggplot(aes(x = meanElasticity,
             y = label,
             color = newtype, 
             fill = newtype)) +
  geom_vline(xintercept = 0, 
             linetype = 1,
             size = 0.2) +
  scale_color_manual(values = group.colors) +
  geom_point() + 
  geom_errorbarh(aes(xmin = meanElasticity - ci,
                     xmax = meanElasticity + ci),
                height = 0.3)

# Highlight rects for functional forms
ym <- 0.25
al <- 0.1
r_lma <- annotate("rect", xmin = -Inf, xmax = Inf, ymin = 1-ym, ymax = 2+ym, fill = "black", alpha = al)
r_card <- annotate("rect", xmin = -Inf, xmax = Inf, ymin = 3-ym, ymax = 4+ym, fill = "black", alpha = al)
r_herbivory <- annotate("rect", xmin = -Inf, xmax = Inf, ymin = 5-ym, ymax = 7+ym, fill = "black", alpha = al)
r_seedlings <- annotate("rect", xmin = -Inf, xmax = Inf, ymin = 10-ym, ymax = 11+ym, fill = "black", alpha = al)
r_pods <- annotate("rect", xmin = -Inf, xmax = Inf, ymin = 12-ym, ymax = 16+ym, fill = "black", alpha = al)
r_surv <- annotate("rect", xmin = -Inf, xmax = Inf, ymin = 17-ym, ymax = 21+ym, fill = "black", alpha = al)
r_flowering <- annotate("rect", xmin = -Inf, xmax = Inf, ymin = 22-ym, ymax = 25+ym, fill = "black", alpha = al)
r_budlings <- annotate("rect", xmin = -Inf, xmax = Inf, ymin = 26-ym, ymax = 27+ym, fill = "black", alpha = al)
r_bdlgs_per_stem <- annotate("rect", xmin = -Inf, xmax = Inf, ymin = 28-ym, ymax = 29+ym, fill = "black", alpha = al)

# Functional form labels
xc <- -0.31
sz <- 2.5
t_bdlgs_per_stem <- annotate("text", x = xc, y = 28.5, label = "Buds per stem", size = sz)
t_budlings <- annotate("text", x = xc, y = 26.5, label = "Budling recruits", size = sz)
t_flowering <- annotate("text", x = xc, y = 23.5, label = "Flowering", size = sz)
t_surv <- annotate("text", x = xc, y = 19, label = "Ramet Survival", size = sz)
t_pods <- annotate("text", x = xc, y = 14, label = "Pods", size = sz)
t_seedlings <- annotate("text", x = xc, y = 10.5, label = "Seedling recruits", size = sz)
t_seed_succ <- annotate("text", x = xc, y = 9, label = "Seed success", size = sz)
t_seeds_per_pod <- annotate("text", x = xc, y = 8, label = "Seeds per pod", size = sz)
t_herbivory <- annotate("text", x = xc, y = 6, label = "Herbivory", size = sz)
t_card <- annotate("text", x = xc, y = 3.5, label = "Cardenolides", size = sz)
t_lma <- annotate("text", x = xc, y = 1.5, label = "LMA", size = sz)

# Throw those puppies in...
elastiplot <- elastiplot + 
  t_surv +
  r_surv + 
  r_lma +
  t_lma +
  r_card +
  t_card +
  t_seeds_per_pod +
  t_seed_succ +
  r_seedlings + 
  t_seedlings +
  r_pods +
  t_pods +
  r_flowering +
  t_flowering +
  r_herbivory +
  t_herbivory +
  r_budlings +
  t_budlings +
  r_bdlgs_per_stem +
  t_bdlgs_per_stem

# Labels and such
elastiplot <- elastiplot + 
  scale_y_discrete(labels = rev(fancypantslabels)) +
  xlab("Parameter elasticity") +
  ylab("Parameters") + 
  theme_bw() +
  labs(color = "Parameter\nType",
       fill = "Parameter\nType") + 
  ggtitle("(a)") +
  theme(legend.background = element_rect(fill="lightgrey",
                                         size=0.1,
                                         linetype="solid"),
        legend.key.size = unit(0.18, "in"),
        legend.position = c(0.89, 0.245),
        plot.title = element_text(hjust = 0,
                                  margin = margin(b = 15, unit = "pt")))

elastiplot
```


## Expanded herbivory elasticities

### Prep data for heatmap of expanded elasticities

```{r, warning=FALSE}
M <- mesh(ipm$vars$h_apical$x, ipm$vars$h_apical$x)

plotdata <- tbl_df(data.frame(h_apical_t0 = as.vector(M$x),
                              h_apical_t1 = as.vector(M$y),
                              elasticity = as.vector(E1),
                              pname = "p[omega]"))
plotdata %<>% bind_rows(tbl_df(data.frame(h_apical_t0 = as.vector(M$x),
                                          h_apical_t1 = as.vector(M$y),
                                          elasticity = as.vector(E3),
                                          pname = "sigma")))
```

### Render expanded elasticity plots for herbivory parameters

```{r}
maxval <- max(abs(c(as.vector(E1), as.vector(E3))))
colorpal <- brewer.pal(3, "RdBu")

pmunch_elastiplot <- ggplot(plotdata, aes(x = h_apical_t0, 
                                          y = h_apical_t1, 
                                          z = elasticity)) +
  geom_raster(aes(fill = elasticity)) +
  facet_grid(pname ~ ., labeller=label_parsed) +
  geom_contour(colour = "black", alpha = 0.3) +
  scale_fill_gradient2(low = "blue",
                       mid = "white",
                       high = "red",
                       limits = c(-maxval,maxval))

pmunch_elastiplot <- pmunch_elastiplot + 
  theme(axis.line = element_blank()) + 
  scale_x_continuous(limits = c(min(ipm$vars$h_apical$x), 
                                max(ipm$vars$h_apical$x)), 
                     expand = c(0, 0)) + 
  scale_y_continuous(limits = c(min(ipm$vars$h_apical$x), 
                                max(ipm$vars$h_apical$x)), 
                     expand = c(0, 0)) + 
  xlab("Height at year t (cm)") + 
  ylab("Height at year t+1 (cm)") +
  labs(fill = "Elasticity") +
  theme_bw() +
  ggtitle("(b)") +
  theme(plot.title = element_text(hjust = 0,
                                  margin = margin(b = 15, unit = "pt")),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

pmunch_elastiplot
```

## Put em together, it just makes sense!

```{r, fig.width=8, fig.height=4}
g1 <- ggplotGrob(elastiplot)
g1 <- gtable_add_rows(g1, unit(0, "mm"))
g1 <- gtable_add_rows(g1, unit(0, "mm"))
g2 <- ggplotGrob(pmunch_elastiplot)
g <- cbind(g1, g2, size="first")

p <- grid.arrange(g1, g2, ncol=2)
ggsave("Figure6_ElasticityAnalysis.png", width=8, height=4, device = "png", p)
```
