---
title: "Fit Budlings per Stem"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
---

**NOTE: this code is deprecated in favor of that in "fit_clonal-transect-blocks.Rmd". We suspect this analysis was at the wrong spatial scale, therefore we broke our transects into 1 m^2 square plots along their length and followed a similar model selection process.

Load data.
```{r}
library(milkweed)
library(dplyr)
library(tidyr)
library(ggplot2)
library(AICcmodavg)
```

Compute budlings per stem.
```{r}
data_gp <- dem.data %>% 
  group_by(year, transect) %>% 
  summarize(N_seedlings = sum(seedling, na.rm=T), 
            N_total = sum(aliveJune, na.rm=T), 
            N_budlings = N_total - N_seedlings,
            herb_mean = mean(herb_avg, na.rm=T),
            site = first(site))

data15_16 <- data_gp %>% filter(transect != 80) %>% #transect 80 was abandoned after 2015 so was not included
  group_by(transect) %>% 
  summarize(bdlgs_per_stem = last(N_budlings)/first(N_total),
            herb_mean = first(herb_mean),
            site = first(site))

traits_15 = trait.data %>%
  group_by(transect) %>%
  summarize(N_mean = mean(N, na.rm=T),
            LMA_mean = mean(LMA, na.rm=T),
            Card_mean = mean(Cardenolides, na.r=T))

transects = levels(traits_15$transect)
merged = merge(filter(data15_16, transect %in% transects), traits_15) #already averaged over transects -> only one year transition
```

Model fits.
```{r}
exp.model <- lm(log(bdlgs_per_stem) ~ herb_mean, data=merged)
lin.model = lm(bdlgs_per_stem ~ herb_mean, data=merged)

lin.model1 <- lm(bdlgs_per_stem ~ herb_mean + N_mean + LMA_mean + Card_mean, data=merged)

lin.model2a = lm(bdlgs_per_stem ~ N_mean + LMA_mean + Card_mean, data=merged)
lin.model2b = lm(bdlgs_per_stem ~ herb_mean + LMA_mean + Card_mean, data=merged)
lin.model2c = lm(bdlgs_per_stem ~ herb_mean + N_mean + Card_mean, data=merged)
lin.model2d = lm(bdlgs_per_stem ~ herb_mean + N_mean + LMA_mean, data=merged)
aictab(list(lin.model1, lin.model2a, lin.model2b, lin.model2c, lin.model2d), modnames = c('1','2a','2b','2c','2d'), second.order=T)

lin.model3a = lm(bdlgs_per_stem ~ LMA_mean + Card_mean, data=merged)
lin.model3b = lm(bdlgs_per_stem ~ N_mean + Card_mean, data=merged)
lin.model3c = lm(bdlgs_per_stem ~ N_mean + LMA_mean, data=merged)
aictab(list(lin.model2a, lin.model3a, lin.model3b, lin.model3c), modnames = c('2a','3a','3b','3c'), second.order=T)

lin.model4a = lm(bdlgs_per_stem ~ herb_mean, data=merged)
lin.model4b = lm(bdlgs_per_stem ~ N_mean, data=merged)
lin.model4c = lm(bdlgs_per_stem ~ LMA_mean, data=merged)
lin.model4d = lm(bdlgs_per_stem ~ Card_mean, data=merged)
aictab(list(lin.model4a, lin.model4b, lin.model4c, lin.model4d), modnames = c('4a','4b','4c','4d'), second.order=T)

lin.model2 = lm(bdlgs_per_stem ~ N_mean, data=merged)
drop1(lin.model2)

cst.model <- lm(bdlgs_per_stem ~ 1, data=merged)

AICc(exp.model)
AICc(lin.model)
AICc(cst.model)
```

```{r}
fit <- exp.model 

plotdata <- data.frame(herb_avg = fit$model$herb_mean, 
                       buds_per_stem = exp(fit$model$`log(bdlgs_per_stem)`),
                       site = merged$site)

p <- plotdata %>% ggplot(aes(x = herb_avg, 
                             y = buds_per_stem,
                             color = site)) + 
                  geom_point()

xpts <- seq(from=0, to=6, length.out = 1000)
ypts <- predict(fit, 
                new = data.frame(herb_mean = xpts), 
                level=0.95,
                interval="confidence",
                se.fit=TRUE)
plotdata <- data.frame(herb_avg = xpts, 
                       buds_per_stem = exp(ypts$fit[,"fit"]),
                       lwr = exp(ypts$fit[,"lwr"]),
                       upr = exp(ypts$fit[,"upr"]),
                       site = NA)

p <- p + geom_line(data = plotdata, 
                   color = "black", 
                   linetype = "solid") +
         geom_ribbon(data = plotdata, 
                     aes(ymin=lwr, 
                         ymax=upr), 
                     alpha = 0.2) + 
         scale_y_continuous(limits = c(0, 2.8))
         
p <- p + theme_bw() +
         xlab("Herbivory Score") +
         ylab("Per capita clonal reproduction\n (sprouts/stem)") +
         labs(color="Sites") + 
         theme(legend.background = element_rect(fill="lightgrey",
                                                size=0.1,
                                                linetype="solid"),
               legend.key.size =  unit(0.2, "in"),
               legend.position = c(0.875, 0.65))

p
```
